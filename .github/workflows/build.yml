name: Build J2ME JAR 
  
on: 
  push: 
    branches: [ main ] 
  workflow_dispatch: 
  
jobs: 
  build: 
    runs-on: ubuntu-latest 
  
    steps: 
    - uses: actions/checkout@v4 
  
    - name: Set up JDK 8 
      uses: actions/setup-java@v4 
      with: 
        java-version: '8' 
        distribution: 'temurin' 
  
    - name: Get Libraries 
      run: | 
        mkdir -p lib 
         
        # Функция для скачивания с жесткой проверкой 
        download_lib() { 
          local file=$1 
          local url=$2 
          echo "Trying $url..." 
          curl -L -f -o "lib/$file" "$url" 
          # Проверяем, что это не HTML страница (404) и файл открывается как zip 
          if unzip -t "lib/$file" > /dev/null 2>&1; then 
            echo "Successfully downloaded valid $file" 
            return 0 
          else 
            echo "Invalid file from $url" 
            rm -f "lib/$file" 
            return 1 
          fi 
        } 
  
        # Ссылки на Maven Central (самые стабильные) + резерв 
        URLS_MIDP=( 
          "https://repo1.maven.org/maven2/org/microemu/midpapi20/2.0.4/midpapi20-2.0.4.jar" 
          "https://raw.githubusercontent.com/the-m-project/j2me-sdk/master/lib/midpapi20.jar" 
        ) 
         
        URLS_CLDC=( 
          "https://repo1.maven.org/maven2/org/microemu/cldcapi11/2.0.4/cldcapi11-2.0.4.jar" 
          "https://raw.githubusercontent.com/the-m-project/j2me-sdk/master/lib/cldcapi11.jar" 
        ) 
  
        for url in "${URLS_MIDP[@]}"; do download_lib "midpapi20.jar" "$url" && break; done 
        for url in "${URLS_CLDC[@]}"; do download_lib "cldcapi11.jar" "$url" && break; done 
  
        if [ ! -f "lib/midpapi20.jar" ] || [ ! -f "lib/cldcapi11.jar" ]; then 
          echo "ERROR: Could not download J2ME libraries!" 
          exit 1 
        fi 
  
    - name: Build 
      run: | 
        mkdir -p classes 
        SOURCE_PATH=$(find . -name "TelegramClient.java" | head -n 1) 
        echo "Compiling $SOURCE_PATH..." 
        javac -source 1.3 -target 1.3 -encoding UTF-8 -bootclasspath lib/midpapi20.jar:lib/cldcapi11.jar -d classes "$SOURCE_PATH" 
  
    - name: Package 
      run: | 
        mkdir -p META-INF 
        cat <<EOT > META-INF/MANIFEST.MF 
        MIDlet-Name: Telegram 
        MIDlet-Version: 1.0.0 
        MIDlet-Vendor: Trae 
        MIDlet-1: Telegram, , TelegramClient 
        MicroEdition-Profile: MIDP-2.0 
        MicroEdition-Configuration: CLDC-1.1 
        EOT 
        echo "Contents of classes directory:" 
        ls -R classes 
        jar cvfm TelegramClient.jar META-INF/MANIFEST.MF -C classes . 
        echo "Current directory contents:" 
        ls -l 
  
    - name: Upload 
      uses: actions/upload-artifact@v4 
      with: 
        name: TelegramClient-JAR 
        path: "*.jar" 
        if-no-files-found: error