# ---Создал Bogdan2248---
name: Build J2ME JAR 
  
on: 
  push: 
    branches: [ main ] 
  workflow_dispatch: 
  
jobs: 
  build: 
    runs-on: ubuntu-latest 
  
    steps: 
    - uses: actions/checkout@v4 
  
    - name: Set up JDK 8 
      uses: actions/setup-java@v4 
      with: 
        java-version: '8' 
        distribution: 'temurin' 
  
    - name: Get Libraries 
      run: | 
        mkdir -p lib 
        download_lib() { 
          local file=$1 
          local url=$2 
          echo "Trying $url..." 
          curl -L -f -o "lib/$file" "$url" 
          if unzip -t "lib/$file" > /dev/null 2>&1; then 
            echo "Successfully downloaded valid $file" 
            return 0 
          else 
            echo "Invalid file from $url" 
            rm -f "lib/$file" 
            return 1 
          fi 
        } 
        URLS_MIDP=( 
          "https://repo1.maven.org/maven2/org/microemu/midpapi20/2.0.4/midpapi20-2.0.4.jar" 
          "https://raw.githubusercontent.com/the-m-project/j2me-sdk/master/lib/midpapi20.jar" 
        ) 
        URLS_CLDC=( 
          "https://repo1.maven.org/maven2/org/microemu/cldcapi11/2.0.4/cldcapi11-2.0.4.jar" 
          "https://raw.githubusercontent.com/the-m-project/j2me-sdk/master/lib/cldcapi11.jar" 
        ) 
        for url in "${URLS_MIDP[@]}"; do download_lib "midpapi20.jar" "$url" && break; done 
        for url in "${URLS_CLDC[@]}"; do download_lib "cldcapi11.jar" "$url" && break; done 
        
        if [ ! -f "lib/midpapi20.jar" ] || [ ! -f "lib/cldcapi11.jar" ]; then 
          echo "ERROR: Could not download J2ME libraries!" 
          exit 1 
        fi 
  
    - name: Build 
      run: | 
        mkdir -p classes 
        SOURCE_PATH=$(find . -name "TelegramClient.java" | head -n 1) 
        echo "Compiling $SOURCE_PATH..." 
        javac -source 1.3 -target 1.3 -encoding UTF-8 -bootclasspath lib/midpapi20.jar:lib/cldcapi11.jar -d classes "$SOURCE_PATH" 
  
    - name: Preverify 
      run: | 
        sudo apt-get update && sudo apt-get install -y proguard 
        # Create a simple proguard config for preverification 
        echo "-injars classes" > preverify.pro 
        echo "-outjars classes_preverified" >> preverify.pro 
        echo "-libraryjars lib/midpapi20.jar" >> preverify.pro 
        echo "-libraryjars lib/cldcapi11.jar" >> preverify.pro 
        echo "-dontoptimize" >> preverify.pro 
        echo "-dontobfuscate" >> preverify.pro 
        echo "-dontwarn" >> preverify.pro 
        echo "-microedition" >> preverify.pro 
        
        proguard @preverify.pro || true 
        
        # If proguard failed to create the dir, we use the original classes but it might fail on phone 
        if [ ! -d "classes_preverified" ]; then 
          echo "WARNING: Preverification failed, using original classes" 
          cp -r classes classes_preverified 
        fi 
  
    - name: Package 
      run: | 
        # Create Manifest 
        mkdir -p classes_preverified/META-INF 
        cp client/META-INF/MANIFEST.MF classes_preverified/META-INF/MANIFEST.MF 
        
        # Build JAR 
        cd classes_preverified 
        jar cvfm ../TelegramClient.jar META-INF/MANIFEST.MF . 
        cd .. 
        
        # Build JAD 
        JAR_SIZE=$(stat -c%s "TelegramClient.jar") 
        cp client/META-INF/MANIFEST.MF TelegramClient.jad 
        echo "MIDlet-Jar-Size: $JAR_SIZE" >> TelegramClient.jad 
        echo "MIDlet-Jar-URL: TelegramClient.jar" >> TelegramClient.jad 
  
    - name: Upload 
      uses: actions/upload-artifact@v4 
      with: 
        name: TelegramClient-Build 
        path: | 
          TelegramClient.jar 
          TelegramClient.jad 
